stages:
  - build
  - deploy


build:
  tags:
    - docker
  stage: build
  image: drud/ddev-webserver:v1.21.2 # PHP 8.0
  script:
    - composer install --no-dev --no-progress --prefer-dist --no-suggest --optimize-autoloader --ignore-platform-reqs
    - cd $CI_PROJECT_DIR
    - npm init -y
    - npm install --save-dev webpack webpack-cli @babel/core babel-loader @babel/preset-env @babel/preset-react @wordpress/scripts
    - npm run build
    - composer update -o
    - find . -type d -name '.git' | xargs rm -rf
    - tar -czf build-$CI_COMMIT_REF_SLUG.tar.gz .
  artifacts:
    expire_in: 1h
    paths:
      - build-$CI_COMMIT_REF_SLUG.tar.gz
    
deploy:
  tags:
      - docker
  stage: deploy
  dependencies:
    - build
  script:
  - echo "Testing deploy script simplicity"
  only:
    - master