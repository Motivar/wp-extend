stages:
  - build
  - deploy


build:
  tags:
    - docker
  stage: build
  artifacts:
    expire_in: 1h
    paths:
      - build-$CI_COMMIT_REF_SLUG.tar.gz
  image: drud/ddev-webserver:v1.21.2 # PHP 8.0
  script:
    - composer install --no-dev --no-progress --prefer-dist --no-suggest --optimize-autoloader --ignore-platform-reqs
    - cd $CI_PROJECT_DIR
    - npm init -y
    - npm install --save-dev webpack webpack-cli @babel/core babel-loader @babel/preset-env @babel/preset-react @wordpress/scripts
    - npm run build
    - composer update -o
    - find . -type d -name '.git' | xargs rm -rf
    - tar -czf build-$CI_COMMIT_REF_SLUG.tar.gz .
  artifacts:
    expire_in: 1h
    paths:
      - build-$CI_COMMIT_REF_SLUG.tar.gz
    
deploy:
  stage: deploy
  tags:
    - docker
  dependencies:
    - build
  script:
    - echo "Deploying the package..."
    - curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file build-$CI_COMMIT_REF_SLUG.tar.gz "$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/generic/$CI_PROJECT_NAME/$CI_PIPELINE_ID/build-$CI_COMMIT_REF_SLUG.tar.gz"
  only:
    - master